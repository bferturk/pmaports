# Based on omap2plus_defconfig
# Enabled CONFIG_DM_CRYPT

_flavor=motorola-maserati
_hash="db250b51bdffe8b5d649506e13b0ba7be43df40a"
_config="config-${_flavor}.${CARCH}"

pkgname=linux-${_flavor}

pkgver=5.0.0
case $pkgver in
	*.*.*)	_kernver=${pkgver%.*};;
	*.*) _kernver=$pkgver;;
esac
pkgrel=0

arch="armv7"
pkgdesc="Linux for Droid 4 from Maemo Leste"
url="https://kernel.org/"
depends=""
makedepends="perl sed installkernel bash gmp-dev bc linux-headers elfutils-dev openssl-dev file bison flex xz"
options="!strip !check !tracedeps"
install=
source="
	$pkgname-${_hash}.tar.gz::https://github.com/maemo-leste/droid4-linux/archive/${_hash}.tar.gz
	config-${_flavor}.armv7
"

license="GPL2"
_abi_release=${pkgver}
_carch=${CARCH}
case "$_carch" in
aarch64*) _carch="arm64" ;;
arm*) _carch="arm" ;;
ppc*) _carch="powerpc" ;;
s390*) _carch="s390" ;;
esac

HOSTCC="${CC:-gcc}"
HOSTCC="${HOSTCC#${CROSS_COMPILE}}"

ksrcdir="$srcdir/droid4-linux-${_hash}"

prepare() {
	cd "$ksrcdir"
	mkdir -p "$srcdir"/build
	cp -v "$srcdir"/$_config "$srcdir"/build/.config
	make -C "$ksrcdir" O="$srcdir"/build ARCH="$_carch" HOSTCC="$HOSTCC" \
		olddefconfig
}

build() {
	cd "$srcdir"/build
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-postmarketOS" \
		CFLAGS_MODULE=-fno-pic
}

package() {
	cd "$srcdir/build/arch/${_carch}/boot"

	if [ "$CARCH" == "aarch64" ]; then
		install -Dm644 "$srcdir/build/arch/${_carch}/boot/Image" \
			"$pkgdir/boot/vmlinuz-$_flavor"
	else
		install -Dm644 "$srcdir/build/arch/${_carch}/boot/"*zImage \
			"$pkgdir/boot/vmlinuz-$_flavor"
	fi

	install -D "$srcdir/build/include/config/kernel.release" \
		"$pkgdir/usr/share/kernel/$_flavor/kernel.release"

	cd "$srcdir"/build

	local _install
	case "$CARCH" in
	aarch64*|arm*)	_install="modules_install dtbs_install" ;;
	*)		_install="modules_install" ;;
	esac

	make -j1 $_install \
		ARCH="$_carch" \
		INSTALL_MOD_PATH="$pkgdir" \
		INSTALL_DTBS_PATH="$pkgdir/usr/share/dtb"
}

sha512sums="f7ad78cb9961604a67200c8a2f8d30ae794fb787fb24dc46dd7a396444af1b7bf735e68451f154e72f74ed40ac3a9a5694764e86be9a027c79ba03e596a7b685  linux-motorola-maserati-db250b51bdffe8b5d649506e13b0ba7be43df40a.tar.gz
b6a93d30f40c352d5baea4e4d275a33ce1ffc9951a57be013adad341db4a9cff9ec9cbd3de21173b979ff3bc5e2f25b8b6492f7717a682b2219a34ee38e09ad7  config-motorola-maserati.armv7"
