From 7d0c9e6215864454d8994ed6d50c51e61ce0202a Mon Sep 17 00:00:00 2001
Message-Id: <7d0c9e6215864454d8994ed6d50c51e61ce0202a.1516189772.git.mirq-linux@rere.qmqm.pl>
In-Reply-To: <ca5e9bd6560a188703123bcef6012ce2efa71aaf.1516189772.git.mirq-linux@rere.qmqm.pl>
References: <ca5e9bd6560a188703123bcef6012ce2efa71aaf.1516189772.git.mirq-linux@rere.qmqm.pl>
From: =?UTF-8?q?Micha=C5=82=20Miros=C5=82aw?= <mirq-linux@rere.qmqm.pl>
Date: Tue, 18 Jul 2017 01:11:28 +0200
Subject: [PATCH 12/52] usb: host: ehci-tegra: Implement PM callbacks
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

Signed-off-by: Michał Mirosław <mirq-linux@rere.qmqm.pl>
---
 drivers/usb/host/ehci-tegra.c | 39 +++++++++++++++++++++++++++++++++++++++
 1 file changed, 39 insertions(+)

diff --git a/drivers/usb/host/ehci-tegra.c b/drivers/usb/host/ehci-tegra.c
index 9a3d7db5be57..56366d2d3120 100644
--- a/drivers/usb/host/ehci-tegra.c
+++ b/drivers/usb/host/ehci-tegra.c
@@ -562,6 +562,42 @@ static void tegra_ehci_hcd_shutdown(struct platform_device *pdev)
 		hcd->driver->shutdown(hcd);
 }
 
+#ifdef CONFIG_PM
+static int tegra_ehci_pm_suspend(struct device *dev)
+{
+	struct usb_hcd *hcd = dev_get_drvdata(dev);
+	struct ehci_hcd *ehci = hcd_to_ehci(hcd);
+	bool do_wakeup = device_may_wakeup(dev);
+
+	dev_dbg(dev, "ehci-tegra PM suspend\n");
+
+	/* Only call ehci_suspend if ehci_setup has been done */
+	if (ehci->sbrn)
+		return ehci_suspend(hcd, do_wakeup);
+
+	return 0;
+}
+
+static int tegra_ehci_pm_resume(struct device *dev)
+{
+	struct usb_hcd *hcd = dev_get_drvdata(dev);
+	struct ehci_hcd *ehci = hcd_to_ehci(hcd);
+
+	dev_dbg(dev, "ehci-msm PM resume\n");
+
+	/* Only call ehci_resume if ehci_setup has been done */
+	if (ehci->sbrn)
+		ehci_resume(hcd, false);
+
+	return 0;
+}
+
+static struct dev_pm_ops tegra_ehci_pm_ops = {
+	.suspend = tegra_ehci_pm_suspend,
+	.resume = tegra_ehci_pm_resume,
+};
+#endif /* CONFIG_PM */
+
 static struct platform_driver tegra_ehci_driver = {
 	.probe		= tegra_ehci_probe,
 	.remove		= tegra_ehci_remove,
@@ -569,6 +605,9 @@ static struct platform_driver tegra_ehci_driver = {
 	.driver		= {
 		.name	= DRV_NAME,
 		.of_match_table = tegra_ehci_of_match,
+#ifdef CONFIG_PM
+		.pm = &tegra_ehci_pm_ops,
+#endif
 	}
 };
 
-- 
2.14.2

